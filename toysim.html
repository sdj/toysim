<html>
<title> Toy Machine Simulator </title>
<body>
<h3>Toy Machine Simulator </h3>

<p>

<script>

label = new Object()
opcode = new Object()
adr = new Object()
prog = new Object()
mem = new Object()
accumulator = 0
pc = 0
ninstr = 0

function numbers() {
   s = ""
   for (i = 1; i <= 15; i++) {
      if (i < 10)
         s += " "
      s += i + "\n"
   }
   // document.f.ln.value = s
}

function compile() {
   var i
   prog = document.f.src.value.split(/[\n\r]/)
   for (i = 0; i < prog.length; i++) {
      label[i] = getlab(prog[i])
      if (/get|print|store|load|add|sub|goto|ifpos|ifzero|stop|rand/.test(label[i]))
         warn(i+1, "warning: should '" + label[i] + "' have a space in front of it??")
      opcode[i] = getop(prog[i])
      if (label[i] == "" && opcode[i] != "" 
          && !(/get|print|store|load|add|sub|goto|ifpos|ifzero|stop|rand/.test(opcode[i])))
         warn(i+1, "error: '" + opcode[i] + "' doesn't seem to be a valid instruction")
      adr[i] = getadr(prog[i])
      if (adr[i] == "" && /store|load|add|sub|goto|ifpos|ifzero/.test(opcode[i]))
         warn(i+1, "error: you need an operand for this operator: " + prog[i])
      mem[i] = 0
      if (opcode[i] == "init")
         mem[i] = adr[i]
      if (/^-?[0-9]+/.test(opcode[i]))  // opcode is a literal number
         mem[i] = adr[i]
   }
   pc = 0
}

function run() {
   document.f.output.value = ""  // clear output
   document.f.accum.value = ""
   pc = 0
   ninstr = 0
   while (pc >= 0)
      instr()
   out("\nstopped")
}

function instr() {
   ninstr++
   if (ninstr > 1000) {   // avoid infinite loops: stop after 1000 instrs
      out("error: infinite loop?")
      pc = -2
      return
   }
   if (/^#/.test(label[pc]) || /^#/.test(opcode[pc]))
      return
   if (opcode[pc] == "stop")
      pc = -2
   else if (opcode[pc] == "get") {
      accumulator = prompt("Enter value for GET", "")
      accumlator = parseFloat(accumulator)
      if (accumulator == null || accumulator == "")
         pc = -2
   } else if (opcode[pc] == "print")
      out(accumulator)
   else if (opcode[pc] == "store")
      mem[findlab(adr[pc])] = parseFloat(accumulator)
   else if (opcode[pc] == "load")
      accumulator = parseFloat(litoradr(adr[pc]))
   else if (opcode[pc] == "add")
      accumulator = parseFloat(accumulator) + parseFloat(litoradr(adr[pc]))
   else if (opcode[pc] == "sub")
      accumulator = parseFloat(accumulator) - parseFloat(litoradr(adr[pc]))
   else if (opcode[pc] == "goto")
      pc = findlab(adr[pc])-1
   else if (opcode[pc] == "ifpos")
      {if (accumulator >= 0) pc = findlab(adr[pc])-1}
   else if (opcode[pc] == "ifzero")
      {if (parseFloat(accumulator) == 0) pc = findlab(adr[pc])-1}
   else if (opcode[pc] == "init") {
      out("error: tried to execute data at " + (pc+1))
      pc = -2;
   } else if (opcode[pc] == "rand") {
         accumulator = Math.floor(Math.random() * 100);
   } else if (opcode[pc] != "") {
      out("error: invalid instruction '" + opcode[pc] + "' at line " + (pc+1))
      pc = -2;
   }
   pc++
}

function litoradr(s) { // decide if s is a literal or an address
   if (/^-?[0-9]+/.test(s))
      return s
   return mem[findlab(s)]
}

function findlab(s) {
   var i
   for (i = 0; i < prog.length; i++)
      if (label[i] == s)
         return i;
   warn(pc+1, "error: there is no instruction labeled " + s);
   return -1;
}

function getlab(s) {
   lab = s.replace(/ +.*/, "") // zap all but front
   return lab.toLowerCase()
}

function getop(s) {
   var op
   op = s.replace(/^[a-zA-Z][^ ]*/, "") // zap label if present
   op = op.replace(/^[ ]+/, "") // zap leading blanks if present
   op = op.replace(/ +.*/, "") // zap after op
   return op.toLowerCase()
}

function getadr(s) {
   var adr
   adr = s.replace(/^[a-zA-Z][^ ]*/, "") // zap label if present
   adr = adr.replace(/^ *[a-zA-Z][^ ]*/, "") // zap op if present
   adr = adr.replace(/^ +/, "") // zap leading blanks if present
   adr = adr.replace(/ +.*/, "") // zap after adr
   return adr.toLowerCase()
}

function out(s) {
   document.f.output.value += s + "\n"
   document.f.output.scrollTop = document.f.output.scrollHeight
   document.f.accum.value = accumulator
}

function warn(n, s) {
   alert("line " + n + " " + s)
}

</script>

<form name=f>
&nbsp;&nbsp;&nbsp;&nbsp; Program:
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp;   Output: <br>
     &nbsp;&nbsp;&nbsp;&nbsp;
<textarea name=src rows=6 cols=15 style="background:#fffafa; border-width:thin" >
top
 rand
 store answer
loop
 get
 print
 sub answer
 ifzero correct
 ifpos lower
 goto higher
correct
 load 999
 print
 stop
lower
 load -111
 print
 goto loop
higher
 load 111
 print
 goto loop
answer 0
</textarea> &nbsp;&nbsp;&nbsp;&nbsp;
<textarea name=output rows=6 cols=15 style="background:#fffff0; border-width:thin"></textarea> &nbsp;&nbsp;&nbsp;&nbsp;
<p>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Accumulator: &nbsp; <input name=accum size=10 style="background:#fffff0">
<P>    &nbsp;&nbsp;&nbsp;&nbsp;
<INPUT TYPE="button" VALUE="RUN" onClick='compile(); run()'>
</form>

<h4> Guess a number! </h4>

<p>This page includes a sample program demonstrating a simple guess a number game. Click run and then enter a number, look in the output box and you'll see your guess and one of three numbers following it:</p>
<ul>
      <li>-111 means your guess was too high and the answer is lower</li>
      <li>111 means your guess was too low and the answer is higher</li>
      <li>999 means you guessed correctly!</li>
</ul>

<p>Notes: This is known to work in FireFox, and does NOT work in Chrome up to v69.
To implement this game a RAND instruction was added to the simulator (see Syntax section).</p>

<h4> Syntax reminder </h4>

<pre>
     get       get a number from keyboard into accumulator
     print     print contents of accumulator
     load <i><i>Val</i></i>  load accumulator with <i>Val</i> (<i>Val</i> unchanged)
     store M   store contents of accumulator into memory location called M (accumulator unchanged)
     add <i>Val</i>   add <i>Val</i> to contents of accumulator (<i>Val</i> unchanged)
     sub <i>Val</i>   subtract <i>Val</i> from contents of accumulator (<i>Val</i> unchanged)
     goto L    go to instruction labeled L
     ifpos L   go to instruction labeled L if accumulator is &gt;= zero
     ifzero L  go to instruction labeled L if accumulator is zero
     stop      stop running
     rand      put random number between 0 and 100 in accumulator
   M Num       before program runs, set this memory location (called M) to numeric value Num
</pre>

If <tt><i>Val</i></tt> is a name like <tt>Sum</tt>, it refers to a labeled
memory location.  If <tt><i>Val</i></tt> is a number like 17, that value is
used directly.  So <tt>add Sum</tt> means to add the contents of the memory
location named <tt>Sum</tt> to the accumulator value (leaving <tt>Sum</tt>'s
contents unchanged), while <tt>add 1</tt> means to add 1 to the
accumulator value.

<P> If you want to see how the simulator works, 
Tools / Web Developer / Page Source in Firefox,
Customize / Tools / View source in Chrome, or
Developer / View Source in Safari.

<P>
This version has a limit of 1000 instructions by default, to make
it easier to prevent infinite loops.  The single-step version has
no limit.
</body>
</html>
